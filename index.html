
<html>

	<title>AMT : Image Segmentation</title>
	<head>

<form name="mturk_form" method="post" id="mturk_form" action="https://www.mturk.com/mturk/externalSubmit">
  <input type="hidden" value="" name="assignmentId" id="assignmentId">


<!-- #################  -->
<!-- cut for form here  -->
<!-- #################  -->

    <input type="hidden" value="" name="segpoly" id="segpoly">

		<style type="text/css">
  		.xlink {cursor:default}
  		.hlink{cursor:help}
      #submitButton {
        display: block;
        width: 120px;
        height: 50px;
        margin: auto;
      }
		</style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<!--[if IE]><script type="text/javascript" src="excanvas.js"></script><![endif]-->
		<script type="text/javascript">

			var CANVAS_WIDTH  = 200;

			var CANVAS_HEIGHT = 250;

      var IMAGE_SRC = 'https://s3.amazonaws.com/bitlaterbucket/turk_segmentation/m-031-01.jpg';
      //var IMAGE_SRC = '${image_url}';

			//global variables for the page
			var img;
			var canvas_fix;
			var ctx;
			var image_path;

			//change the base url to point to where the images are located
			//var base_url = 'http://www.cs.berkeley.edu/~smaji/projects/mturk/interfaces/segmentation/';
			var base_url = ".";

			//polygon coordinates
			var x = new Array();
			var y = new Array();

			//current location
			var cx=0;
			var cy=0;

			var numpts=0;

			//tolerance radius
			var tr=5;

			//drawing styles
			var linecolor = "red";
			var linewidth = 4.0;
			var pt_size   = 4.0;
			var pt_color  = "black";

			// closed or open polygon
			var polygon_is_closed = false;

			// index of the point selected
			var selected_idx = -1;

			// top level initialization of the canvas
			function init_canvas(){
				img = new Image();

				img.src = IMAGE_SRC;
				canvas_fix = document.getElementById("segmentation_canvas");
				ctx = canvas_fix.getContext("2d");
				canvas_fix.onmousemove = mousemove_canvas;
				canvas_fix.onmousedown = mousedown_canvas;
				canvas_fix.onmouseup   = mouseup_canvas;
				img.onload = draw_image;
				draw_canvas();
			}
			// draw canvas
			function draw_canvas(){
				//draw the image
				ctx.clearRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);
				draw_image();
				draw_polygon();
			}

			// fix this - wait to draw the image (see if this really works)
			function draw_image(){
				ctx.drawImage(img,0,0,CANVAS_WIDTH, CANVAS_HEIGHT);
			}

			// reset the annotation
			function reset_annotation(){
				selected_idx = -1;
				polygon_is_closed = false;
				x = new Array();
				y = new Array();
				numpts = 0;
			}
			// true if the point is close to the start
			function is_close_to_start(){
				if(numpts > 0){
					var d2 = (cx-x[0])*(cx-x[0]) + (cy-y[0])*(cy-y[0]);
					return d2 < tr*tr;
				}else{
					return false;
				}
			}
			// returns the index of the point close to the current one (within tr)
			function get_closest_point_idx(){
				var idx = -1;
				var min_dist = 100000000;
				for(var i=0;i<numpts;i++){
					var d2 = (cx-x[i])*(cx-x[i]) + (cy-y[i])*(cy-y[i]);
					if(d2 < min_dist){
						min_dist = d2;
						idx = i;
					}
				}
				if(min_dist < tr*tr)
					return idx;
				else
					return -1;
			}

			// draw the current point
			function draw_current_point(r){
				ctx.fillStyle = 'blue';
				ctx.fillRect(cx-r,cy-r,2*r,2*r);
			}

			// draw the polygon
			function draw_polygon(){
				ctx.strokeStyle = linecolor;
				ctx.lineWidth = linewidth;
				for(i = 0; i < numpts-1; i++){
					ctx.beginPath();
					ctx.moveTo(x[i],y[i]);
					ctx.lineTo(x[i+1],y[i+1]);
					ctx.stroke();

				}
				for(i = 0; i < numpts; i++){
					ctx.fillRect(x[i]-pt_size,y[i]-pt_size,2*pt_size,2*pt_size);
				}
				if(numpts > 0){
					if(polygon_is_closed){
						ctx.beginPath();
						ctx.moveTo(x[numpts-1],y[numpts-1]);
						ctx.lineTo(x[0],y[0]); // the current location
						ctx.stroke();
					}else{
						ctx.beginPath();
						ctx.moveTo(x[numpts-1],y[numpts-1]);
						ctx.lineTo(cx,cy); // the current location
						ctx.stroke();
						if(is_close_to_start())
							draw_current_point(2*pt_size);
						else
							draw_current_point(pt_size);
					}
				}

			}

			// GUI input handling
			function grab_xy(event){
				var ev = event || window.event;

				var IE = document.all?true:false;
				if (IE) { // grab the x-y pos if browser is IE
					cx = ev.clientX + document.body.scrollLeft;
					cy = ev.clientY + document.body.scrollTop;
				}
				else {  // grab the x-y pos if browser is NS
					cx = ev.pageX;
					cy = ev.pageY;
				}
				cx = cx - canvas_fix.offsetLeft;
				cy = cy - canvas_fix.offsetTop;
				if (cx < 0){cx = 0;}
				if (cy < 0){cy = 0;}
				if (cx > CANVAS_WIDTH) {cx = CANVAS_WIDTH};
				if (cy > CANVAS_HEIGHT){cy = CANVAS_HEIGHT};

				return [cx,cy];
			}
			function mouseup_canvas(event){
				if(polygon_is_closed){
					selected_idx = -1;
				}else{
						if(is_close_to_start()){
						polygon_is_closed = true;
						selected_idx = -1;
					}else{
						var xy = grab_xy(event)
						x[numpts] = xy[0];
						y[numpts] = xy[1];
						numpts = numpts + 1;
						draw_canvas();
					}
				}
			}
			function mousedown_canvas(event){
				selected_idx = get_closest_point_idx();

			}
			//update the current location of the keypoint
			function mousemove_canvas(event){
				var xy = grab_xy(event);
				cx = xy[0];
				cy = xy[1];
				if(polygon_is_closed && selected_idx >= 0){
					x[selected_idx] = cx;
					y[selected_idx] = cy;
				}
				draw_canvas();
			}

			//add a point to the list polygon
			function onclick_canvas(event){
				if(polygon_is_closed)
					return;
				//close the polygon
				if(is_close_to_start()){
					polygon_is_closed = true;
				}else{
					var xy = grab_xy(event)
					x[numpts] = xy[0];
					y[numpts] = xy[1];
					numpts = numpts + 1;
					draw_canvas();
				}
			}
			//keys to reset the annotation
			function keydown(event) {
				var key = String.fromCharCode(event.keyCode || event.which);
				switch (key) {
						case "R":
						reset_annotation();
						break;
				}
				draw_canvas();
			}
			/// functions related to AMT task
			function gup(name){
				var regexS = "[\\?&]"+name+"=([^&#]*)";
				var regex = new RegExp( regexS );
				var tmpURL = window.location.href;
				var results = regex.exec( tmpURL );
				if( results == null )
					return "";
				else
					return results[1];
			}
			//
			// This method decodes the query parameters that were URL-encoded
			//
			function decode(strToDecode)
			{
				var encoded = strToDecode;
				return unescape(encoded.replace(/\+/g,  " "));
			}
			// what to submit to AMT server
			function get_results_string(){
				var result = IMAGE_SRC + "::::"
				for(var i=0;i<numpts;i++){
					result +=  "," + x[i] + "," + y[i];
				}
				return result;
			}

      $(function() {
        init_canvas();
        $('#mturk_form').submit(function(event) {
          if(polygon_is_closed) {
            var results = get_results_string();
            $('#segpoly').val(results);
  					return;
  				}
          alert("Please close the polygon before submitting.");
          event.preventDefault();
        });

      })

	</script>
	</head>
	<body>
	<div align=center ><h3 style="color:green"> Draw the outline of the person within the box</h3></div>
	<div align=center style="color:black"> (<em>press <b>r</b> to reset)</em> </div> <br/>

	<div style="text-align:center;" class="xlink">
    <script type="text/javascript">
      document.write('<canvas id="segmentation_canvas" width=' + CANVAS_WIDTH + ' height='+ CANVAS_HEIGHT +'></canvas>')
    </script>
  </div>

<!-- #################  -->
<!--   stop cut here    -->
<!-- #################  -->


<p class="text-center"><input type="submit" id="submitButton" class="btn btn-primary" value="Submit"></p>

</form>


	</body>
</html>
